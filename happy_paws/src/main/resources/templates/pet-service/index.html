<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>Create product</title>
  <link th:replace="layout :: bootstrapCssLink"/>
  <style>
    span {
      color: red;
    }
  </style>
</head>
<body>
<nav th:replace="/layout :: navigationBar"></nav>
<div class="container my-2">
  <form action="/products/create" method="post" th:object="${product}">
    <label for="name">Name:</label>
    <input id="name" type="text" th:field="*{name}" class="form-control"/>
    <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span>
    <br/>
    <label for="price">Price:</label>
    <input id="price" type="number" th:field="*{price}" class="form-control"/>
    <span th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></span>
    <br/>
    <label for="thumbnailURL">ThumbnailURL:</label>
    <input type="hidden" id="thumbnailURL" th:field="*{thumbnailURL}" />
    <input id="btnThumbnailURL" type="file" class="form-control"/>
    <span th:if="${#fields.hasErrors('thumbnailURL')}" th:errors="*{thumbnailURL}"></span>
    <progress id="uploader" value="0" max="100">0%</progress>
    <br/>

    <label for="productTypeDTO">Product type:</label>
    <select id="productTypeDTO" th:field="*{productTypeDTO.id}">
      <option th:each="pt : ${productTypes}" th:text="${pt.name}" th:value="${pt.id}">
      </option>
    </select>
    <span th:if="${#fields.hasErrors('productTypeDTO')}" th:errors="*{productTypeDTO}"></span>
    <br/>

    <input type="submit"/>
  </form>
</div>
</body>

<script src="https://www.gstatic.com/firebasejs/3.7.4/firebase.js"></script>
<script src="index.js">
</script>
<script>
  const config = {
    apiKey: <API_KEY>,
      authDomain: <FIREBASE_AUTH_DOMAIN>,
        projectId: <FIREBASE_PROJECT_ID>,
          storageBucket: <FIREBASE_STORAGE_BUCKET>,
            messagingSenderId: <FIREBASE_MESSAGING_SENDER_ID>,
              appId: <FIREBASE_APP_ID>,
                measurementId: <FIREBASE_MEASUREMENT_ID>
                  };
                  firebase.initializeApp(config);
                  //-------------------------------------

                  let uploader = document.getElementById('uploader');
                  let fileButton = document.getElementById('btnThumbnailURL');
                  fileButton.addEventListener('change', function (e) {
                  let file = e.target.files[0];
                  let storageRef = firebase.storage().ref('img/' + file.name);
                  let task = storageRef.put(file);
                  task.on('state_changed', function progress(snapshot) {
                  let percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                  uploader.value = percentage;

                });

                  task
                  .then(snapshot => snapshot.ref.getDownloadURL())
                  .then(url => {
                  document.getElementById('thumbnailURL').setAttribute("value", url);
                })
                });

</script>

</html>
